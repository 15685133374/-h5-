{"remainingRequest":"d:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\babel-loader\\lib\\index.js!d:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\@vue\\cli-plugin-eslint\\node_modules\\eslint-loader\\index.js??ref--13-0!d:\\project\\luban\\luban-h5\\front-end\\h5\\src\\store\\modules\\work.js","dependencies":[{"path":"d:\\project\\luban\\luban-h5\\front-end\\h5\\src\\store\\modules\\work.js","mtime":1575956069375},{"path":"d:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1575454486584},{"path":"d:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\babel-loader\\lib\\index.js","mtime":1575361257763},{"path":"d:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\@vue\\cli-plugin-eslint\\node_modules\\eslint-loader\\index.js","mtime":1575454465101}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/es6.array.sort\";\nimport _slicedToArray from \"d:\\\\project\\\\luban\\\\luban-h5\\\\front-end\\\\h5\\\\node_modules\\\\@babel\\\\runtime-corejs2/helpers/esm/slicedToArray\";\nimport \"core-js/modules/es6.regexp.split\";\nimport _defineProperty from \"d:\\\\project\\\\luban\\\\luban-h5\\\\front-end\\\\h5\\\\node_modules\\\\@babel\\\\runtime-corejs2/helpers/esm/defineProperty\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport Element from \"../../components/core/models/element\";\nimport strapi from \"../../utils/strapi\";\nimport Page from \"../../components/core/models/page\";\nimport Work from \"../../components/core/models/work\";\nimport { AxiosWrapper } from \"../../utils/http.js\";\nimport router from '@/router.js';\nimport { takeScreenshot } from \"../../utils/canvas-helper.js\";\n\nfunction setLoading(commit, loadingName, isLoading) {\n  commit('loading/update', {\n    type: loadingName,\n    payload: isLoading\n  }, {\n    root: true\n  });\n}\n\nexport var actions = {\n  previewWork: function previewWork(_ref) {\n    var commit = _ref.commit;\n    var payload = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    commit('previewWork', payload);\n  },\n  deployWork: function deployWork(_ref2) {\n    var commit = _ref2.commit;\n    var payload = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    commit('previewWork', payload);\n  },\n  createWork: function createWork(_ref3, payload) {\n    var commit = _ref3.commit;\n    strapi.createEntry('works', new Work()).then(function (entry) {\n      var routeData = router.resolve({\n        name: 'editor',\n        params: {\n          workId: entry.id\n        }\n      });\n      window.open(routeData.href, '_blank'); // 如果希望不打开新 tab，可以注释上面面两行，启用下面一行的代码即可，不过不推荐。将编辑器单独起一个页面更有利于 vuex 的数据管理\n      // router.replace({ name: 'editor', params: { workId: entry.id } })\n    });\n  },\n  updateWork: function updateWork(_ref4) {\n    var commit = _ref4.commit,\n        state = _ref4.state;\n    var payload = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    // update work with strapi\n    var work = _objectSpread({}, state.work, {}, payload);\n\n    commit('setWork', work);\n  },\n\n  /**\r\n   * isSaveCover {Boolean} 保存作品时，是否保存封面图\r\n   * loadingName {String} saveWork_loading, previewWork_loading\r\n   * 预览作品之前需要先保存，但希望 用户点击保存按钮 和 点击预览按钮 loading_name 能够不同（虽然都调用了 saveWork）\r\n   * 因为 loading 效果要放在不同的按钮上\r\n   */\n  saveWork: function saveWork(_ref5) {\n    var commit = _ref5.commit,\n        dispatch = _ref5.dispatch,\n        state = _ref5.state;\n\n    var _ref6 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n        _ref6$isSaveCover = _ref6.isSaveCover,\n        isSaveCover = _ref6$isSaveCover === void 0 ? false : _ref6$isSaveCover,\n        _ref6$loadingName = _ref6.loadingName,\n        loadingName = _ref6$loadingName === void 0 ? 'saveWork_loading' : _ref6$loadingName;\n\n    var fn = function fn(callback) {\n      new AxiosWrapper({\n        dispatch: dispatch,\n        commit: commit,\n        loading_name: loadingName,\n        successMsg: '保存作品成功',\n        customRequest: strapi.updateEntry.bind(strapi)\n      }).put('works', state.work.id, state.work).then(callback);\n    };\n\n    return new Promise(function (resolve, reject) {\n      if (isSaveCover) {\n        setLoading(commit, 'uploadWorkCover_loading', true);\n        takeScreenshot().then(function (file) {\n          dispatch('uploadCover', {\n            file: file\n          }).then(function () {\n            setLoading(commit, 'uploadWorkCover_loading', false);\n            fn(resolve);\n          }); // uploadCover\n        }); // takeScreenshot\n      } else {\n        fn(resolve);\n      }\n    });\n  },\n  fetchWork: function fetchWork(_ref7, workId) {\n    var commit = _ref7.commit,\n        state = _ref7.state;\n    strapi.getEntry('works', workId).then(function (entry) {\n      commit('setWork', entry);\n      commit('setEditingPage');\n    });\n  },\n  fetchWorks: function fetchWorks(_ref8, workId) {\n    var commit = _ref8.commit,\n        dispatch = _ref8.dispatch,\n        state = _ref8.state;\n\n    // console.log('********',window.location.href.split('/')[3].split('#')[0])\n    if (window.location.href.split('/')[3].split('#')[0] != '') {\n      new AxiosWrapper({\n        dispatch: dispatch,\n        commit: commit,\n        name: 'editor/setWorks',\n        loading_name: 'fetchWorks_loading',\n        successMsg: '获取作品列表成功',\n        customRequest: strapi.getEntries.bind(strapi)\n      }).get('works', {\n        is_template: false,\n        'user_id': window.location.href.split('/')[3].split('#')[0]\n      });\n    } else {\n      window.location.href = 'http://www.yuntvg.com';\n    }\n  },\n  fetchWorkTemplates: function fetchWorkTemplates(_ref9, workId) {\n    var commit = _ref9.commit,\n        dispatch = _ref9.dispatch,\n        state = _ref9.state;\n    new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      name: 'editor/setWorkTemplates',\n      loading_name: 'fetchWorkTemplates_loading',\n      successMsg: '获取模板列表成功',\n      customRequest: strapi.getEntries.bind(strapi)\n    }).get('works', {\n      is_template: true\n    });\n  },\n\n  /**\r\n   *\r\n   * @param {*} workId\r\n   * response demo:\r\n   {\r\n    \"uuidMap2Name\": {\r\n        \"1565596393441\": \"姓名\",\r\n        \"1565596397671\": \"学校\"\r\n    },\r\n    \"formRecords\": [\r\n        {\r\n            \"id\": 3,\r\n            \"form\": {\r\n                \"1565369322603\": \"abc\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-09T16:52:28.826Z\",\r\n            \"updated_at\": \"2019-08-09T16:52:28.832Z\"\r\n        },\r\n        {\r\n            \"id\": 4,\r\n            \"form\": {\r\n                \"1565595388440\": \"ddd\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:36:54.521Z\",\r\n            \"updated_at\": \"2019-08-11T07:36:54.526Z\"\r\n        },\r\n        {\r\n            \"id\": 5,\r\n            \"form\": {\r\n                \"1565595388440\": \"acd\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:45:22.000Z\",\r\n            \"updated_at\": \"2019-08-11T07:45:22.005Z\"\r\n        },\r\n        {\r\n            \"id\": 6,\r\n            \"form\": {\r\n                \"1565596393441\": \"b\",\r\n                \"1565596397671\": \"a\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:59:00.938Z\",\r\n            \"updated_at\": \"2019-08-11T07:59:00.943Z\"\r\n        },\r\n        {\r\n            \"id\": 7,\r\n            \"form\": {\r\n                \"1565596393441\": \"b\",\r\n                \"1565596397671\": \"a\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:59:37.065Z\",\r\n            \"updated_at\": \"2019-08-11T07:59:37.070Z\"\r\n        }\r\n      ]\r\n    }\r\n   */\n  fetchFormsOfWork: function fetchFormsOfWork(_ref10, workId) {\n    var commit = _ref10.commit,\n        state = _ref10.state,\n        dispatch = _ref10.dispatch;\n    // 可以 return Promise\n    new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      name: 'editor/formDetailOfWork',\n      loading_name: 'queryFormsOfWork_loading',\n      successMsg: '表单查询完毕'\n    }).get(\"/works/form/query/\".concat(workId));\n  },\n  setWorkAsTemplate: function setWorkAsTemplate(_ref11, workId) {\n    var commit = _ref11.commit,\n        state = _ref11.state,\n        dispatch = _ref11.dispatch;\n    new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      // name: 'editor/formDetailOfWork',\n      loading_name: 'setWorkAsTemplate_loading',\n      successMsg: '设置为模板成功'\n    }).post(\"/works/set-as-template/\".concat(workId || state.work.id));\n  },\n  useTemplate: function useTemplate(_ref12, workId) {\n    var commit = _ref12.commit,\n        state = _ref12.state,\n        dispatch = _ref12.dispatch;\n    return new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      // name: 'editor/formDetailOfWork',\n      loading_name: 'useTemplate_loading',\n      successMsg: '使用模板成功'\n    }).post(\"/works/use-template/\".concat(workId));\n  },\n  uploadCover: function uploadCover(_ref13) {\n    var commit = _ref13.commit,\n        state = _ref13.state,\n        dispatch = _ref13.dispatch;\n\n    var _ref14 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n        file = _ref14.file;\n\n    var formData = new FormData();\n    formData.append('files', file, \"\".concat(+new Date(), \".png\"));\n    formData.append('workId', state.work.id);\n    return new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      name: 'editor/setWorkCover',\n      loading_name: 'uploadWorkCover_loading',\n      successMsg: '上传封面图成功!' // }).post(`/works/uploadCover/${state.work.id}`, formData)\n\n    }).post(\"/upload/\", formData);\n  }\n}; // mutations\n\nexport var mutations = {\n  /**\r\n   *\r\n   * @param {*} state\r\n   * @param {Object} payload\r\n   *\r\n    value example: [\r\n      {\r\n        \"id\": 1,\r\n        \"name\": \"1567769149231.png\",\r\n        \"hash\": \"1660b11229e7473b90f99a9f9afe7675\",\r\n        \"sha256\": \"lKl7f_csUAgOjf0VRYkBZ64EcTjvt4Dt4beNIhELpTU\",\r\n        \"ext\": \".png\",\r\n        \"mime\": \"image/png\",\r\n        \"size\": \"6.57\",\r\n        \"url\": \"/uploads/1660b11229e7473b90f99a9f9afe7675.png\",\r\n        \"provider\": \"local\",\r\n        \"public_id\": null,\r\n        \"created_at\": \"2019-09-06T11:25:49.255Z\",\r\n        \"updated_at\": \"2019-09-06T11:25:49.261Z\",\r\n        \"related\": []\r\n      }\r\n    ]\r\n   */\n  setWorkCover: function setWorkCover(state, _ref15) {\n    var type = _ref15.type,\n        value = _ref15.value;\n\n    var _value = _slicedToArray(value, 1),\n        cover = _value[0];\n\n    state.work.cover_image_url = cover.url;\n  },\n\n  /**\r\n   * payload: {\r\n   *  type:   @params {String} \"editor/setWorks\",\r\n   *  value:  @params {Array}  work list\r\n   * }\r\n   */\n  setWorks: function setWorks(state, _ref16) {\n    var type = _ref16.type,\n        value = _ref16.value;\n    value.sort(function (a, b) {\n      return b.id - a.id;\n    });\n    state.works = value;\n  },\n\n  /**\r\n   * payload: {\r\n   *  type:   @params {String} \"editor/setWorks\",\r\n   *  value:  @params {Array}  work list\r\n   * }\r\n   */\n  setWorkTemplates: function setWorkTemplates(state, _ref17) {\n    var type = _ref17.type,\n        value = _ref17.value;\n    value.sort(function (a, b) {\n      return b.id - a.id;\n    });\n    state.workTemplates = value;\n  },\n  setWork: function setWork(state, work) {\n    window.__work = work;\n    work.pages = work.pages.map(function (page) {\n      page.elements = page.elements.map(function (element) {\n        return new Element(element);\n      });\n      return new Page(page);\n    });\n    state.work = work;\n  },\n  previewWork: function previewWork(state, _ref18) {\n    var type = _ref18.type,\n        value = _ref18.value;\n  },\n  deployWork: function deployWork(state, _ref19) {\n    var type = _ref19.type,\n        value = _ref19.value;\n  },\n  formDetailOfWork: function formDetailOfWork(state, _ref20) {\n    var type = _ref20.type,\n        value = _ref20.value;\n    state.formDetailOfWork = value;\n  }\n};",{"version":3,"sources":["d:/project/luban/luban-h5/front-end/h5/src/store/modules/work.js"],"names":["Element","strapi","Page","Work","AxiosWrapper","router","takeScreenshot","setLoading","commit","loadingName","isLoading","type","payload","root","actions","previewWork","deployWork","createWork","createEntry","then","entry","routeData","resolve","name","params","workId","id","window","open","href","updateWork","state","work","saveWork","dispatch","isSaveCover","fn","callback","loading_name","successMsg","customRequest","updateEntry","bind","put","Promise","reject","file","fetchWork","getEntry","fetchWorks","location","split","getEntries","get","is_template","fetchWorkTemplates","fetchFormsOfWork","setWorkAsTemplate","post","useTemplate","uploadCover","formData","FormData","append","Date","mutations","setWorkCover","value","cover","cover_image_url","url","setWorks","sort","a","b","works","setWorkTemplates","workTemplates","setWork","__work","pages","map","page","elements","element","formDetailOfWork"],"mappings":"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","sourcesContent":["import Element from '../../components/core/models/element'\r\nimport strapi from '../../utils/strapi'\r\nimport Page from '../../components/core/models/page'\r\nimport Work from '../../components/core/models/work'\r\nimport { AxiosWrapper } from '../../utils/http.js'\r\nimport router from '@/router.js'\r\nimport { takeScreenshot } from '../../utils/canvas-helper.js'\r\n\r\nfunction setLoading (commit, loadingName, isLoading) {\r\n  commit('loading/update', { type: loadingName, payload: isLoading }, { root: true })\r\n}\r\n\r\nexport const actions = {\r\n  previewWork ({ commit }, payload = {}) {\r\n    commit('previewWork', payload)\r\n  },\r\n  deployWork ({ commit }, payload = {}) {\r\n    commit('previewWork', payload)\r\n  },\r\n  createWork ({ commit }, payload) {\r\n    strapi.createEntry('works', new Work()).then(entry => {\r\n      const routeData = router.resolve({ name: 'editor', params: { workId: entry.id } })\r\n      window.open(routeData.href, '_blank')\r\n      // 如果希望不打开新 tab，可以注释上面面两行，启用下面一行的代码即可，不过不推荐。将编辑器单独起一个页面更有利于 vuex 的数据管理\r\n      // router.replace({ name: 'editor', params: { workId: entry.id } })\r\n    })\r\n  },\r\n  updateWork ({ commit, state }, payload = {}) {\r\n    // update work with strapi\r\n    const work = {\r\n      ...state.work,\r\n      ...payload\r\n    }\r\n    commit('setWork', work)\r\n  },\r\n  /**\r\n   * isSaveCover {Boolean} 保存作品时，是否保存封面图\r\n   * loadingName {String} saveWork_loading, previewWork_loading\r\n   * 预览作品之前需要先保存，但希望 用户点击保存按钮 和 点击预览按钮 loading_name 能够不同（虽然都调用了 saveWork）\r\n   * 因为 loading 效果要放在不同的按钮上\r\n   */\r\n  saveWork ({ commit, dispatch, state }, { isSaveCover = false, loadingName = 'saveWork_loading' } = {}) {\r\n    const fn = (callback) => {\r\n      new AxiosWrapper({\r\n        dispatch,\r\n        commit,\r\n        loading_name: loadingName,\r\n        successMsg: '保存作品成功',\r\n        customRequest: strapi.updateEntry.bind(strapi)\r\n      }).put('works', state.work.id, state.work).then(callback)\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n      if (isSaveCover) {\r\n        setLoading(commit, 'uploadWorkCover_loading', true)\r\n        takeScreenshot().then(file => {\r\n          dispatch('uploadCover', { file }).then(() => {\r\n            setLoading(commit, 'uploadWorkCover_loading', false)\r\n            fn(resolve)\r\n          }) // uploadCover\r\n        }) // takeScreenshot\r\n      } else {\r\n        fn(resolve)\r\n      }\r\n    })\r\n  },\r\n  fetchWork ({ commit, state }, workId) {\r\n    strapi.getEntry('works', workId).then(entry => {\r\n      commit('setWork', entry)\r\n      commit('setEditingPage')\r\n    })\r\n  },\r\n  fetchWorks ({ commit, dispatch, state }, workId) {\r\n    // console.log('********',window.location.href.split('/')[3].split('#')[0])\r\n    if(window.location.href.split('/')[3].split('#')[0] != ''){\r\n      new AxiosWrapper({\r\n        dispatch,\r\n        commit,\r\n        name: 'editor/setWorks',\r\n        loading_name: 'fetchWorks_loading',\r\n        successMsg: '获取作品列表成功',\r\n        customRequest: strapi.getEntries.bind(strapi)\r\n      }).get('works', { is_template: false, 'user_id' : window.location.href.split('/')[3].split('#')[0] })\r\n    }else{\r\n      window.location.href = 'http://www.yuntvg.com'\r\n    }\r\n    \r\n  },\r\n  fetchWorkTemplates ({ commit, dispatch, state }, workId) {\r\n    new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      name: 'editor/setWorkTemplates',\r\n      loading_name: 'fetchWorkTemplates_loading',\r\n      successMsg: '获取模板列表成功',\r\n      customRequest: strapi.getEntries.bind(strapi)\r\n    }).get('works', { is_template: true })\r\n  },\r\n  /**\r\n   *\r\n   * @param {*} workId\r\n   * response demo:\r\n   {\r\n    \"uuidMap2Name\": {\r\n        \"1565596393441\": \"姓名\",\r\n        \"1565596397671\": \"学校\"\r\n    },\r\n    \"formRecords\": [\r\n        {\r\n            \"id\": 3,\r\n            \"form\": {\r\n                \"1565369322603\": \"abc\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-09T16:52:28.826Z\",\r\n            \"updated_at\": \"2019-08-09T16:52:28.832Z\"\r\n        },\r\n        {\r\n            \"id\": 4,\r\n            \"form\": {\r\n                \"1565595388440\": \"ddd\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:36:54.521Z\",\r\n            \"updated_at\": \"2019-08-11T07:36:54.526Z\"\r\n        },\r\n        {\r\n            \"id\": 5,\r\n            \"form\": {\r\n                \"1565595388440\": \"acd\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:45:22.000Z\",\r\n            \"updated_at\": \"2019-08-11T07:45:22.005Z\"\r\n        },\r\n        {\r\n            \"id\": 6,\r\n            \"form\": {\r\n                \"1565596393441\": \"b\",\r\n                \"1565596397671\": \"a\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:59:00.938Z\",\r\n            \"updated_at\": \"2019-08-11T07:59:00.943Z\"\r\n        },\r\n        {\r\n            \"id\": 7,\r\n            \"form\": {\r\n                \"1565596393441\": \"b\",\r\n                \"1565596397671\": \"a\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:59:37.065Z\",\r\n            \"updated_at\": \"2019-08-11T07:59:37.070Z\"\r\n        }\r\n      ]\r\n    }\r\n   */\r\n  fetchFormsOfWork ({ commit, state, dispatch }, workId) {\r\n    // 可以 return Promise\r\n    new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      name: 'editor/formDetailOfWork',\r\n      loading_name: 'queryFormsOfWork_loading',\r\n      successMsg: '表单查询完毕'\r\n    }).get(`/works/form/query/${workId}`)\r\n  },\r\n  setWorkAsTemplate ({ commit, state, dispatch }, workId) {\r\n    new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      // name: 'editor/formDetailOfWork',\r\n      loading_name: 'setWorkAsTemplate_loading',\r\n      successMsg: '设置为模板成功'\r\n    }).post(`/works/set-as-template/${workId || state.work.id}`)\r\n  },\r\n  useTemplate ({ commit, state, dispatch }, workId) {\r\n    return new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      // name: 'editor/formDetailOfWork',\r\n      loading_name: 'useTemplate_loading',\r\n      successMsg: '使用模板成功'\r\n    }).post(`/works/use-template/${workId}`)\r\n  },\r\n  uploadCover ({ commit, state, dispatch }, { file } = {}) {\r\n    const formData = new FormData()\r\n    formData.append('files', file, `${+new Date()}.png`)\r\n    formData.append('workId', state.work.id)\r\n    return new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      name: 'editor/setWorkCover',\r\n      loading_name: 'uploadWorkCover_loading',\r\n      successMsg: '上传封面图成功!'\r\n    // }).post(`/works/uploadCover/${state.work.id}`, formData)\r\n    }).post(`/upload/`, formData)\r\n  }\r\n}\r\n\r\n// mutations\r\nexport const mutations = {\r\n  /**\r\n   *\r\n   * @param {*} state\r\n   * @param {Object} payload\r\n   *\r\n    value example: [\r\n      {\r\n        \"id\": 1,\r\n        \"name\": \"1567769149231.png\",\r\n        \"hash\": \"1660b11229e7473b90f99a9f9afe7675\",\r\n        \"sha256\": \"lKl7f_csUAgOjf0VRYkBZ64EcTjvt4Dt4beNIhELpTU\",\r\n        \"ext\": \".png\",\r\n        \"mime\": \"image/png\",\r\n        \"size\": \"6.57\",\r\n        \"url\": \"/uploads/1660b11229e7473b90f99a9f9afe7675.png\",\r\n        \"provider\": \"local\",\r\n        \"public_id\": null,\r\n        \"created_at\": \"2019-09-06T11:25:49.255Z\",\r\n        \"updated_at\": \"2019-09-06T11:25:49.261Z\",\r\n        \"related\": []\r\n      }\r\n    ]\r\n   */\r\n  setWorkCover (state, { type, value }) {\r\n    const [cover] = value\r\n    state.work.cover_image_url = cover.url\r\n  },\r\n  /**\r\n   * payload: {\r\n   *  type:   @params {String} \"editor/setWorks\",\r\n   *  value:  @params {Array}  work list\r\n   * }\r\n   */\r\n  setWorks (state, { type, value }) {\r\n    value.sort((a, b) => b.id - a.id)\r\n    state.works = value\r\n  },\r\n  /**\r\n   * payload: {\r\n   *  type:   @params {String} \"editor/setWorks\",\r\n   *  value:  @params {Array}  work list\r\n   * }\r\n   */\r\n  setWorkTemplates (state, { type, value }) {\r\n    value.sort((a, b) => b.id - a.id)\r\n    state.workTemplates = value\r\n  },\r\n  setWork (state, work) {\r\n    window.__work = work\r\n    work.pages = work.pages.map(page => {\r\n      page.elements = page.elements.map(element => new Element(element))\r\n      return new Page(page)\r\n    })\r\n    state.work = work\r\n  },\r\n  previewWork (state, { type, value }) {},\r\n  deployWork (state, { type, value }) {},\r\n  formDetailOfWork (state, { type, value }) {\r\n    state.formDetailOfWork = value\r\n  }\r\n}"]}]}
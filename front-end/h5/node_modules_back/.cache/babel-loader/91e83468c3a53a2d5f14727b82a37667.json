{"remainingRequest":"D:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\babel-loader\\lib\\index.js!D:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\@vue\\cli-plugin-eslint\\node_modules\\eslint-loader\\index.js??ref--13-0!D:\\project\\luban\\luban-h5\\front-end\\h5\\src\\store\\modules\\work.js","dependencies":[{"path":"D:\\project\\luban\\luban-h5\\front-end\\h5\\src\\store\\modules\\work.js","mtime":1575526862412},{"path":"D:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1575454486584},{"path":"D:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\babel-loader\\lib\\index.js","mtime":1575361257763},{"path":"D:\\project\\luban\\luban-h5\\front-end\\h5\\node_modules\\@vue\\cli-plugin-eslint\\node_modules\\eslint-loader\\index.js","mtime":1575454465101}],"contextDependencies":[],"result":["import \"core-js/modules/es7.object.get-own-property-descriptors\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.object.keys\";\nimport \"core-js/modules/es6.array.sort\";\nimport _slicedToArray from \"D:\\\\project\\\\luban\\\\luban-h5\\\\front-end\\\\h5\\\\node_modules\\\\@babel\\\\runtime-corejs2/helpers/esm/slicedToArray\";\nimport _defineProperty from \"D:\\\\project\\\\luban\\\\luban-h5\\\\front-end\\\\h5\\\\node_modules\\\\@babel\\\\runtime-corejs2/helpers/esm/defineProperty\";\nimport \"core-js/modules/es6.regexp.replace\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport Element from \"../../components/core/models/element\";\nimport strapi from \"../../utils/strapi\";\nimport Page from \"../../components/core/models/page\";\nimport Work from \"../../components/core/models/work\";\nimport { AxiosWrapper } from \"../../utils/http.js\";\nimport router from '@/router.js';\nimport { takeScreenshot } from \"../../utils/canvas-helper.js\";\n\nfunction setLoading(commit, loadingName, isLoading) {\n  commit('loading/update', {\n    type: loadingName,\n    payload: isLoading\n  }, {\n    root: true\n  });\n}\n\nexport var actions = {\n  previewWork: function previewWork(_ref) {\n    var commit = _ref.commit;\n    var payload = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    commit('previewWork', payload);\n  },\n  deployWork: function deployWork(_ref2) {\n    var commit = _ref2.commit;\n    var payload = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n    commit('previewWork', payload);\n  },\n  createWork: function createWork(_ref3, payload) {\n    var commit = _ref3.commit;\n    strapi.createEntry('works', new Work()).then(function (entry) {\n      commit('setWork', entry);\n      router.replace({\n        name: 'editor',\n        params: {\n          workId: entry.id\n        }\n      }); // window.location = `${window.location.origin}/#/editor/${entry.id}`\n    }); // commit('createWork')\n    // commit('pageManager', { type: 'add' })\n    // commit('setEditingPage')\n  },\n  updateWork: function updateWork(_ref4) {\n    var commit = _ref4.commit,\n        state = _ref4.state;\n    var payload = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n    // update work with strapi\n    var work = _objectSpread({}, state.work, {}, payload);\n\n    commit('setWork', work);\n  },\n\n  /**\r\n   * isSaveCover {Boolean} 保存作品时，是否保存封面图\r\n   */\n  saveWork: function saveWork(_ref5) {\n    var commit = _ref5.commit,\n        dispatch = _ref5.dispatch,\n        state = _ref5.state;\n\n    var _ref6 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n        _ref6$isSaveCover = _ref6.isSaveCover,\n        isSaveCover = _ref6$isSaveCover === void 0 ? false : _ref6$isSaveCover;\n\n    var fn = function fn(callback) {\n      new AxiosWrapper({\n        dispatch: dispatch,\n        commit: commit,\n        loading_name: 'saveWork_loading',\n        successMsg: '保存作品成功',\n        customRequest: strapi.updateEntry.bind(strapi)\n      }).put('works', state.work.id, state.work).then(callback);\n    };\n\n    return new Promise(function (resolve, reject) {\n      if (isSaveCover) {\n        setLoading(commit, 'uploadWorkCover_loading', true);\n        takeScreenshot().then(function (file) {\n          dispatch('uploadCover', {\n            file: file\n          }).then(function () {\n            setLoading(commit, 'uploadWorkCover_loading', false);\n            fn(resolve);\n          }); // uploadCover\n        }); // takeScreenshot\n      } else {\n        fn(resolve);\n      }\n    });\n  },\n  fetchWork: function fetchWork(_ref7, workId) {\n    var commit = _ref7.commit,\n        state = _ref7.state;\n    strapi.getEntry('works', workId).then(function (entry) {\n      commit('setWork', entry);\n      commit('setEditingPage');\n    });\n  },\n  fetchWorks: function fetchWorks(_ref8, workId) {\n    var commit = _ref8.commit,\n        dispatch = _ref8.dispatch,\n        state = _ref8.state;\n    new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      name: 'editor/setWorks',\n      loading_name: 'fetchWorks_loading',\n      successMsg: '获取作品列表成功',\n      customRequest: strapi.getEntries.bind(strapi)\n    }).get('works', {\n      is_template: false\n    });\n  },\n  fetchWorkTemplates: function fetchWorkTemplates(_ref9, workId) {\n    var commit = _ref9.commit,\n        dispatch = _ref9.dispatch,\n        state = _ref9.state;\n    new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      name: 'editor/setWorkTemplates',\n      loading_name: 'fetchWorkTemplates_loading',\n      successMsg: '获取模板列表成功',\n      customRequest: strapi.getEntries.bind(strapi)\n    }).get('works', {\n      is_template: true\n    });\n  },\n\n  /**\r\n   *\r\n   * @param {*} workId\r\n   * response demo:\r\n   {\r\n    \"uuidMap2Name\": {\r\n        \"1565596393441\": \"姓名\",\r\n        \"1565596397671\": \"学校\"\r\n    },\r\n    \"formRecords\": [\r\n        {\r\n            \"id\": 3,\r\n            \"form\": {\r\n                \"1565369322603\": \"abc\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-09T16:52:28.826Z\",\r\n            \"updated_at\": \"2019-08-09T16:52:28.832Z\"\r\n        },\r\n        {\r\n            \"id\": 4,\r\n            \"form\": {\r\n                \"1565595388440\": \"ddd\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:36:54.521Z\",\r\n            \"updated_at\": \"2019-08-11T07:36:54.526Z\"\r\n        },\r\n        {\r\n            \"id\": 5,\r\n            \"form\": {\r\n                \"1565595388440\": \"acd\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:45:22.000Z\",\r\n            \"updated_at\": \"2019-08-11T07:45:22.005Z\"\r\n        },\r\n        {\r\n            \"id\": 6,\r\n            \"form\": {\r\n                \"1565596393441\": \"b\",\r\n                \"1565596397671\": \"a\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:59:00.938Z\",\r\n            \"updated_at\": \"2019-08-11T07:59:00.943Z\"\r\n        },\r\n        {\r\n            \"id\": 7,\r\n            \"form\": {\r\n                \"1565596393441\": \"b\",\r\n                \"1565596397671\": \"a\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:59:37.065Z\",\r\n            \"updated_at\": \"2019-08-11T07:59:37.070Z\"\r\n        }\r\n      ]\r\n    }\r\n   */\n  fetchFormsOfWork: function fetchFormsOfWork(_ref10, workId) {\n    var commit = _ref10.commit,\n        state = _ref10.state,\n        dispatch = _ref10.dispatch;\n    // 可以 return Promise\n    new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      name: 'editor/formDetailOfWork',\n      loading_name: 'queryFormsOfWork_loading',\n      successMsg: '表单查询完毕'\n    }).get(\"/works/form/query/\".concat(workId));\n  },\n  setWorkAsTemplate: function setWorkAsTemplate(_ref11, workId) {\n    var commit = _ref11.commit,\n        state = _ref11.state,\n        dispatch = _ref11.dispatch;\n    new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      // name: 'editor/formDetailOfWork',\n      loading_name: 'setWorkAsTemplate_loading',\n      successMsg: '设置为模板成功'\n    }).post(\"/works/set-as-template/\".concat(workId || state.work.id));\n  },\n  useTemplate: function useTemplate(_ref12, workId) {\n    var commit = _ref12.commit,\n        state = _ref12.state,\n        dispatch = _ref12.dispatch;\n    return new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      // name: 'editor/formDetailOfWork',\n      loading_name: 'useTemplate_loading',\n      successMsg: '使用模板成功'\n    }).post(\"/works/use-template/\".concat(workId));\n  },\n  uploadCover: function uploadCover(_ref13) {\n    var commit = _ref13.commit,\n        state = _ref13.state,\n        dispatch = _ref13.dispatch;\n\n    var _ref14 = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n        file = _ref14.file;\n\n    var formData = new FormData();\n    formData.append('files', file, \"\".concat(+new Date(), \".png\"));\n    formData.append('workId', state.work.id);\n    return new AxiosWrapper({\n      dispatch: dispatch,\n      commit: commit,\n      name: 'editor/setWorkCover',\n      loading_name: 'uploadWorkCover_loading',\n      successMsg: '上传封面图成功!' // }).post(`/works/uploadCover/${state.work.id}`, formData)\n\n    }).post(\"/upload/\", formData);\n  }\n}; // mutations\n\nexport var mutations = {\n  /**\r\n   *\r\n   * @param {*} state\r\n   * @param {Object} payload\r\n   *\r\n    value example: [\r\n      {\r\n        \"id\": 1,\r\n        \"name\": \"1567769149231.png\",\r\n        \"hash\": \"1660b11229e7473b90f99a9f9afe7675\",\r\n        \"sha256\": \"lKl7f_csUAgOjf0VRYkBZ64EcTjvt4Dt4beNIhELpTU\",\r\n        \"ext\": \".png\",\r\n        \"mime\": \"image/png\",\r\n        \"size\": \"6.57\",\r\n        \"url\": \"/uploads/1660b11229e7473b90f99a9f9afe7675.png\",\r\n        \"provider\": \"local\",\r\n        \"public_id\": null,\r\n        \"created_at\": \"2019-09-06T11:25:49.255Z\",\r\n        \"updated_at\": \"2019-09-06T11:25:49.261Z\",\r\n        \"related\": []\r\n      }\r\n    ]\r\n   */\n  setWorkCover: function setWorkCover(state, _ref15) {\n    var type = _ref15.type,\n        value = _ref15.value;\n\n    var _value = _slicedToArray(value, 1),\n        cover = _value[0];\n\n    state.work.cover_image_url = cover.url;\n  },\n\n  /**\r\n   * payload: {\r\n   *  type:   @params {String} \"editor/setWorks\",\r\n   *  value:  @params {Array}  work list\r\n   * }\r\n   */\n  setWorks: function setWorks(state, _ref16) {\n    var type = _ref16.type,\n        value = _ref16.value;\n    value.sort(function (a, b) {\n      return b.id - a.id;\n    });\n    state.works = value;\n  },\n\n  /**\r\n   * payload: {\r\n   *  type:   @params {String} \"editor/setWorks\",\r\n   *  value:  @params {Array}  work list\r\n   * }\r\n   */\n  setWorkTemplates: function setWorkTemplates(state, _ref17) {\n    var type = _ref17.type,\n        value = _ref17.value;\n    value.sort(function (a, b) {\n      return b.id - a.id;\n    });\n    state.workTemplates = value;\n  },\n  setWork: function setWork(state, work) {\n    window.__work = work;\n    work.pages = work.pages.map(function (page) {\n      page.elements = page.elements.map(function (element) {\n        return new Element(element);\n      });\n      return new Page(page);\n    });\n    state.work = work;\n  },\n  // createWork (state) {\n  //   state.work = new Work()\n  // },\n  previewWork: function previewWork(state, _ref18) {\n    var type = _ref18.type,\n        value = _ref18.value;\n  },\n  deployWork: function deployWork(state, _ref19) {\n    var type = _ref19.type,\n        value = _ref19.value;\n  },\n  formDetailOfWork: function formDetailOfWork(state, _ref20) {\n    var type = _ref20.type,\n        value = _ref20.value;\n    state.formDetailOfWork = value;\n  }\n};",{"version":3,"sources":["D:/project/luban/luban-h5/front-end/h5/src/store/modules/work.js"],"names":["Element","strapi","Page","Work","AxiosWrapper","router","takeScreenshot","setLoading","commit","loadingName","isLoading","type","payload","root","actions","previewWork","deployWork","createWork","createEntry","then","entry","replace","name","params","workId","id","updateWork","state","work","saveWork","dispatch","isSaveCover","fn","callback","loading_name","successMsg","customRequest","updateEntry","bind","put","Promise","resolve","reject","file","fetchWork","getEntry","fetchWorks","getEntries","get","is_template","fetchWorkTemplates","fetchFormsOfWork","setWorkAsTemplate","post","useTemplate","uploadCover","formData","FormData","append","Date","mutations","setWorkCover","value","cover","cover_image_url","url","setWorks","sort","a","b","works","setWorkTemplates","workTemplates","setWork","window","__work","pages","map","page","elements","element","formDetailOfWork"],"mappings":"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","sourcesContent":["import Element from '../../components/core/models/element'\r\nimport strapi from '../../utils/strapi'\r\nimport Page from '../../components/core/models/page'\r\nimport Work from '../../components/core/models/work'\r\nimport { AxiosWrapper } from '../../utils/http.js'\r\nimport router from '@/router.js'\r\nimport { takeScreenshot } from '../../utils/canvas-helper.js'\r\n\r\nfunction setLoading (commit, loadingName, isLoading) {\r\n  commit('loading/update', { type: loadingName, payload: isLoading }, { root: true })\r\n}\r\n\r\nexport const actions = {\r\n  previewWork ({ commit }, payload = {}) {\r\n    commit('previewWork', payload)\r\n  },\r\n  deployWork ({ commit }, payload = {}) {\r\n    commit('previewWork', payload)\r\n  },\r\n  createWork ({ commit }, payload) {\r\n    strapi.createEntry('works', new Work()).then(entry => {\r\n      commit('setWork', entry)\r\n      router.replace({ name: 'editor', params: { workId: entry.id } })\r\n      // window.location = `${window.location.origin}/#/editor/${entry.id}`\r\n    })\r\n    // commit('createWork')\r\n    // commit('pageManager', { type: 'add' })\r\n    // commit('setEditingPage')\r\n  },\r\n  updateWork ({ commit, state }, payload = {}) {\r\n    // update work with strapi\r\n    const work = {\r\n      ...state.work,\r\n      ...payload\r\n    }\r\n    commit('setWork', work)\r\n  },\r\n  /**\r\n   * isSaveCover {Boolean} 保存作品时，是否保存封面图\r\n   */\r\n  saveWork ({ commit, dispatch, state }, { isSaveCover = false } = {}) {\r\n    const fn = (callback) => {\r\n      new AxiosWrapper({\r\n        dispatch,\r\n        commit,\r\n        loading_name: 'saveWork_loading',\r\n        successMsg: '保存作品成功',\r\n        customRequest: strapi.updateEntry.bind(strapi)\r\n      }).put('works', state.work.id, state.work).then(callback)\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n      if (isSaveCover) {\r\n        setLoading(commit, 'uploadWorkCover_loading', true)\r\n        takeScreenshot().then(file => {\r\n          dispatch('uploadCover', { file }).then(() => {\r\n            setLoading(commit, 'uploadWorkCover_loading', false)\r\n            fn(resolve)\r\n          }) // uploadCover\r\n        }) // takeScreenshot\r\n      } else {\r\n        fn(resolve)\r\n      }\r\n    })\r\n  },\r\n  fetchWork ({ commit, state }, workId) {\r\n    strapi.getEntry('works', workId).then(entry => {\r\n      commit('setWork', entry)\r\n      commit('setEditingPage')\r\n    })\r\n  },\r\n  fetchWorks ({ commit, dispatch, state }, workId) {\r\n    new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      name: 'editor/setWorks',\r\n      loading_name: 'fetchWorks_loading',\r\n      successMsg: '获取作品列表成功',\r\n      customRequest: strapi.getEntries.bind(strapi)\r\n    }).get('works', { is_template: false })\r\n  },\r\n  fetchWorkTemplates ({ commit, dispatch, state }, workId) {\r\n    new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      name: 'editor/setWorkTemplates',\r\n      loading_name: 'fetchWorkTemplates_loading',\r\n      successMsg: '获取模板列表成功',\r\n      customRequest: strapi.getEntries.bind(strapi)\r\n    }).get('works', { is_template: true })\r\n  },\r\n  /**\r\n   *\r\n   * @param {*} workId\r\n   * response demo:\r\n   {\r\n    \"uuidMap2Name\": {\r\n        \"1565596393441\": \"姓名\",\r\n        \"1565596397671\": \"学校\"\r\n    },\r\n    \"formRecords\": [\r\n        {\r\n            \"id\": 3,\r\n            \"form\": {\r\n                \"1565369322603\": \"abc\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-09T16:52:28.826Z\",\r\n            \"updated_at\": \"2019-08-09T16:52:28.832Z\"\r\n        },\r\n        {\r\n            \"id\": 4,\r\n            \"form\": {\r\n                \"1565595388440\": \"ddd\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:36:54.521Z\",\r\n            \"updated_at\": \"2019-08-11T07:36:54.526Z\"\r\n        },\r\n        {\r\n            \"id\": 5,\r\n            \"form\": {\r\n                \"1565595388440\": \"acd\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:45:22.000Z\",\r\n            \"updated_at\": \"2019-08-11T07:45:22.005Z\"\r\n        },\r\n        {\r\n            \"id\": 6,\r\n            \"form\": {\r\n                \"1565596393441\": \"b\",\r\n                \"1565596397671\": \"a\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:59:00.938Z\",\r\n            \"updated_at\": \"2019-08-11T07:59:00.943Z\"\r\n        },\r\n        {\r\n            \"id\": 7,\r\n            \"form\": {\r\n                \"1565596393441\": \"b\",\r\n                \"1565596397671\": \"a\"\r\n            },\r\n            \"work\": 8,\r\n            \"created_at\": \"2019-08-11T07:59:37.065Z\",\r\n            \"updated_at\": \"2019-08-11T07:59:37.070Z\"\r\n        }\r\n      ]\r\n    }\r\n   */\r\n  fetchFormsOfWork ({ commit, state, dispatch }, workId) {\r\n    // 可以 return Promise\r\n    new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      name: 'editor/formDetailOfWork',\r\n      loading_name: 'queryFormsOfWork_loading',\r\n      successMsg: '表单查询完毕'\r\n    }).get(`/works/form/query/${workId}`)\r\n  },\r\n  setWorkAsTemplate ({ commit, state, dispatch }, workId) {\r\n    new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      // name: 'editor/formDetailOfWork',\r\n      loading_name: 'setWorkAsTemplate_loading',\r\n      successMsg: '设置为模板成功'\r\n    }).post(`/works/set-as-template/${workId || state.work.id}`)\r\n  },\r\n  useTemplate ({ commit, state, dispatch }, workId) {\r\n    return new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      // name: 'editor/formDetailOfWork',\r\n      loading_name: 'useTemplate_loading',\r\n      successMsg: '使用模板成功'\r\n    }).post(`/works/use-template/${workId}`)\r\n  },\r\n  uploadCover ({ commit, state, dispatch }, { file } = {}) {\r\n    const formData = new FormData()\r\n    formData.append('files', file, `${+new Date()}.png`)\r\n    formData.append('workId', state.work.id)\r\n    return new AxiosWrapper({\r\n      dispatch,\r\n      commit,\r\n      name: 'editor/setWorkCover',\r\n      loading_name: 'uploadWorkCover_loading',\r\n      successMsg: '上传封面图成功!'\r\n    // }).post(`/works/uploadCover/${state.work.id}`, formData)\r\n    }).post(`/upload/`, formData)\r\n  }\r\n}\r\n\r\n// mutations\r\nexport const mutations = {\r\n  /**\r\n   *\r\n   * @param {*} state\r\n   * @param {Object} payload\r\n   *\r\n    value example: [\r\n      {\r\n        \"id\": 1,\r\n        \"name\": \"1567769149231.png\",\r\n        \"hash\": \"1660b11229e7473b90f99a9f9afe7675\",\r\n        \"sha256\": \"lKl7f_csUAgOjf0VRYkBZ64EcTjvt4Dt4beNIhELpTU\",\r\n        \"ext\": \".png\",\r\n        \"mime\": \"image/png\",\r\n        \"size\": \"6.57\",\r\n        \"url\": \"/uploads/1660b11229e7473b90f99a9f9afe7675.png\",\r\n        \"provider\": \"local\",\r\n        \"public_id\": null,\r\n        \"created_at\": \"2019-09-06T11:25:49.255Z\",\r\n        \"updated_at\": \"2019-09-06T11:25:49.261Z\",\r\n        \"related\": []\r\n      }\r\n    ]\r\n   */\r\n  setWorkCover (state, { type, value }) {\r\n    const [cover] = value\r\n    state.work.cover_image_url = cover.url\r\n  },\r\n  /**\r\n   * payload: {\r\n   *  type:   @params {String} \"editor/setWorks\",\r\n   *  value:  @params {Array}  work list\r\n   * }\r\n   */\r\n  setWorks (state, { type, value }) {\r\n    value.sort((a, b) => b.id - a.id)\r\n    state.works = value\r\n  },\r\n  /**\r\n   * payload: {\r\n   *  type:   @params {String} \"editor/setWorks\",\r\n   *  value:  @params {Array}  work list\r\n   * }\r\n   */\r\n  setWorkTemplates (state, { type, value }) {\r\n    value.sort((a, b) => b.id - a.id)\r\n    state.workTemplates = value\r\n  },\r\n  setWork (state, work) {\r\n    window.__work = work\r\n    work.pages = work.pages.map(page => {\r\n      page.elements = page.elements.map(element => new Element(element))\r\n      return new Page(page)\r\n    })\r\n    state.work = work\r\n  },\r\n  // createWork (state) {\r\n  //   state.work = new Work()\r\n  // },\r\n  previewWork (state, { type, value }) {},\r\n  deployWork (state, { type, value }) {},\r\n  formDetailOfWork (state, { type, value }) {\r\n    state.formDetailOfWork = value\r\n  }\r\n}\r\n"]}]}